var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
import { Injectable } from "@angular/core";
let ParametersService = class ParametersService {
    constructor() {
        if (!this.filterData)
            this.filterData = new Map();
    }
    getFilterData() {
        return this.getUrlObject();
    }
    clearFilterData() {
        this.filterData = new Map();
        return this.getUrlObject();
    }
    filterToUrl(parameter) {
        switch (parameter.behavior) {
            case 'checklist':
            case 'radiolist':
                this.filterToUrlChecboxlist(parameter);
                break;
            case 'onecheck':
                this.filterToUrlOnecheck(parameter);
                break;
            case 'input':
                this.filterToUrlInput(parameter);
                break;
            default:
                throw Error('Неизвестный тип параметра фильтра');
        }
        return this.getUrlObject();
    }
    filterToUrlChecboxlist(parameter) {
        let valuesSelected = parameter.values.filter(v => v.selected);
        if (valuesSelected.length) {
            let valuesFiltered = valuesSelected.map(v => v.url);
            let fake = {};
            fake[parameter.url] = valuesFiltered;
            this.filterData.set(parameter._id, fake);
        }
        else {
            this.filterData.delete(parameter._id);
        }
        return this.filterData;
    }
    filterToUrlOnecheck(parameter) {
        let valuesSelected = parameter.values[0].selected;
        let fake = {};
        fake[parameter.url] = valuesSelected ? parameter.values[0].url : 'net';
        this.filterData.set(parameter._id, fake);
    }
    filterToUrlInput(parameter) {
        let valuesSelected = !!parameter.from || !!parameter.to;
        if (valuesSelected) {
            let fake = {};
            let queryValues = [];
            if (parameter.from)
                queryValues.push(`from_${parameter.from}`);
            if (parameter.to)
                queryValues.push(`to_${parameter.to}`);
            if (queryValues.length)
                fake[parameter.url] = queryValues;
            this.filterData.set(parameter._id, fake);
        }
        else {
            this.filterData.delete(parameter._id);
        }
    }
    getUrlObject() {
        let values = this.filterData.values();
        let valuesArray = Array.from(values);
        return valuesArray.length ? Object.assign({}, ...valuesArray) : {};
    }
    urlToParameter(parameter, queryParams) {
        switch (parameter.behavior) {
            case 'checklist':
            case 'radiolist':
            case 'onecheck':
                return this.urlToFilterChecboxlist(parameter, queryParams);
            case 'input':
                return this.urlToFilterInput(parameter, queryParams);
            default:
                throw Error('Неизвестный тип параметра фильтра');
        }
    }
    urlToFilterChecboxlist(parameter, queryParams) {
        for (let prop in queryParams) {
            if (parameter.url == prop) {
                parameter.values.forEach(v => {
                    if (Array.isArray(queryParams[prop]))
                        v.selected = queryParams[prop].includes(v.url);
                    else
                        v.selected = queryParams[prop] == v.url;
                });
                this.filterToUrl(parameter);
            }
        }
        return parameter;
    }
    urlToFilterInput(parameter, queryParams) {
        for (let prop in queryParams) {
            if (parameter.url == prop) {
                let fromRegexp = new RegExp(/from_(\d+)/), toRegexp = new RegExp(/to_(\d+)/), from = fromRegexp.exec(queryParams[prop]), to = toRegexp.exec(queryParams[prop]);
                if (from)
                    parameter.from = from[1];
                if (to)
                    parameter.to = to[1];
                this.filterToUrl(parameter);
            }
        }
        return parameter;
    }
};
ParametersService = __decorate([
    Injectable(),
    __metadata("design:paramtypes", [])
], ParametersService);
export { ParametersService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyYW1ldGVycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInBhcmFtZXRlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUl6QyxJQUFhLGlCQUFpQixHQUE5QjtJQUVJO1FBQ0ksRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDO1lBQ2pCLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUNwQyxDQUFDO0lBS00sYUFBYTtRQUNoQixNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFBO0lBQzlCLENBQUM7SUFFTSxlQUFlO1FBQ2xCLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUM1QixNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFBO0lBQzlCLENBQUM7SUFFTSxXQUFXLENBQUMsU0FBb0I7UUFDbkMsTUFBTSxDQUFDLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7WUFDekIsS0FBSyxXQUFXLENBQUM7WUFDakIsS0FBSyxXQUFXO2dCQUNaLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFDdkMsS0FBSyxDQUFDO1lBQ1YsS0FBSyxVQUFVO2dCQUNYLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFDcEMsS0FBSyxDQUFDO1lBRVYsS0FBSyxPQUFPO2dCQUNSLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFDakMsS0FBSyxDQUFDO1lBRVY7Z0JBQ0ksTUFBTSxLQUFLLENBQUMsbUNBQW1DLENBQUMsQ0FBQTtRQUN4RCxDQUFDO1FBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQTtJQUM5QixDQUFDO0lBRU8sc0JBQXNCLENBQUMsU0FBb0I7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SSxJQUFJLFdBQVcsQ0FBQyxDQUFDLENBQUM7WUFDM0IsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLEdBQUcsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUV4QixJQUFJLFVBQVUsR0FBRyxJQUFJLE1BQU0sQ0FBQyxZQUFZLENBQUMsRUFDckMsUUFBUSxHQUFHLElBQUksTUFBTSxDQUFDLFVBQVUsQ0FBQyxFQUNqQyxJQUFJLEdBQUcsVUFBVSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsRUFDekMsRUFBRSxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7Z0JBQzFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDTCxTQUFTLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDN0IsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDO29CQUNILFNBQVMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN6QixJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ2hDLENBQUM7UUFDTCxDQUFDO1FBRUQsTUFBTSxDQUFDLFNBQVMsQ0FBQztJQUNyQixDQUFDO0NBR0osQ0FBQTtBQXJJWSxpQkFBaUI7SUFEN0IsVUFBVSxFQUFFOztHQUNBLGlCQUFpQixDQXFJN0I7U0FySVksaUJBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJbmplY3RhYmxlfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xyXG5pbXBvcnQge1BhcmFtZXRlcn0gZnJvbSBcIi4uL2VudGl0aWVzL3BhcmFtZXRlclwiO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgUGFyYW1ldGVyc1NlcnZpY2Uge1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgICAgIGlmICghdGhpcy5maWx0ZXJEYXRhKVxyXG4gICAgICAgICAgICB0aGlzLmZpbHRlckRhdGEgPSBuZXcgTWFwKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBmaWx0ZXJEYXRhOiBNYXA8c3RyaW5nLCBvYmplY3Q+O1xyXG4gICAgcHJpdmF0ZSBwYXJhbWV0ZXJzOiBQYXJhbWV0ZXJbXTtcclxuXHJcbiAgICBwdWJsaWMgZ2V0RmlsdGVyRGF0YSgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRVcmxPYmplY3QoKVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBjbGVhckZpbHRlckRhdGEoKSB7XHJcbiAgICAgICAgdGhpcy5maWx0ZXJEYXRhID0gbmV3IE1hcCgpO1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdldFVybE9iamVjdCgpXHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGZpbHRlclRvVXJsKHBhcmFtZXRlcjogUGFyYW1ldGVyKSB7XHJcbiAgICAgICAgc3dpdGNoIChwYXJhbWV0ZXIuYmVoYXZpb3IpIHtcclxuICAgICAgICAgICAgY2FzZSAnY2hlY2tsaXN0JzpcclxuICAgICAgICAgICAgY2FzZSAncmFkaW9saXN0JzpcclxuICAgICAgICAgICAgICAgIHRoaXMuZmlsdGVyVG9VcmxDaGVjYm94bGlzdChwYXJhbWV0ZXIpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ29uZWNoZWNrJzpcclxuICAgICAgICAgICAgICAgIHRoaXMuZmlsdGVyVG9VcmxPbmVjaGVjayhwYXJhbWV0ZXIpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICBjYXNlICdpbnB1dCc6XHJcbiAgICAgICAgICAgICAgICB0aGlzLmZpbHRlclRvVXJsSW5wdXQocGFyYW1ldGVyKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCfQndC10LjQt9Cy0LXRgdGC0L3Ri9C5INGC0LjQvyDQv9Cw0YDQsNC80LXRgtGA0LAg0YTQuNC70YzRgtGA0LAnKVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRVcmxPYmplY3QoKVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZmlsdGVyVG9VcmxDaGVjYm94bGlzdChwYXJhbWV0ZXI6IFBhcmFtZXRlcikge1xyXG4gICAgICAgIGxldCB2YWx1ZXNTZWxlY3RlZCA9IHBhcmFtZXRlci52YWx1ZXMuZmlsdGVyKHYgPT4gdi5zZWxlY3RlZCk7XHJcbiAgICAgICAgaWYgKHZhbHVlc1NlbGVjdGVkLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBsZXQgdmFsdWVzRmlsdGVyZWQ6IHN0cmluZ1tdID0gdmFsdWVzU2VsZWN0ZWQubWFwKHYgPT4gdi51cmwpO1xyXG4gICAgICAgICAgICBsZXQgZmFrZSA9IHt9O1xyXG4gICAgICAgICAgICBmYWtlW3BhcmFtZXRlci51cmxdID0gdmFsdWVzRmlsdGVyZWQ7XHJcbiAgICAgICAgICAgIHRoaXMuZmlsdGVyRGF0YS5zZXQocGFyYW1ldGVyLl9pZCwgZmFrZSlcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuZmlsdGVyRGF0YS5kZWxldGUocGFyYW1ldGVyLl9pZClcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZmlsdGVyRGF0YVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZmlsdGVyVG9VcmxPbmVjaGVjayhwYXJhbWV0ZXI6IFBhcmFtZXRlcikge1xyXG4gICAgICAgIGxldCB2YWx1ZXNTZWxlY3RlZCA9IHBhcmFtZXRlci52YWx1ZXNbMF0uc2VsZWN0ZWQ7XHJcbiAgICAgICAgbGV0IGZha2UgPSB7fTtcclxuICAgICAgICBmYWtlW3BhcmFtZXRlci51cmxdID0gdmFsdWVzU2VsZWN0ZWQgPyBwYXJhbWV0ZXIudmFsdWVzWzBdLnVybCA6ICduZXQnO1xyXG4gICAgICAgIHRoaXMuZmlsdGVyRGF0YS5zZXQocGFyYW1ldGVyLl9pZCwgZmFrZSlcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGZpbHRlclRvVXJsSW5wdXQocGFyYW1ldGVyOiBQYXJhbWV0ZXIpIHtcclxuICAgICAgICBsZXQgdmFsdWVzU2VsZWN0ZWQgPSAhIXBhcmFtZXRlci5mcm9tIHx8ICEhcGFyYW1ldGVyLnRvO1xyXG4gICAgICAgIGlmICh2YWx1ZXNTZWxlY3RlZCkge1xyXG4gICAgICAgICAgICBsZXQgZmFrZSA9IHt9O1xyXG4gICAgICAgICAgICBsZXQgcXVlcnlWYWx1ZXMgPSBbXTtcclxuICAgICAgICAgICAgaWYgKHBhcmFtZXRlci5mcm9tKVxyXG4gICAgICAgICAgICAgICAgcXVlcnlWYWx1ZXMucHVzaChgZnJvbV8ke3BhcmFtZXRlci5mcm9tfWApO1xyXG4gICAgICAgICAgICBpZiAocGFyYW1ldGVyLnRvKVxyXG4gICAgICAgICAgICAgICAgcXVlcnlWYWx1ZXMucHVzaChgdG9fJHtwYXJhbWV0ZXIudG99YCk7XHJcbiAgICAgICAgICAgIGlmIChxdWVyeVZhbHVlcy5sZW5ndGgpXHJcbiAgICAgICAgICAgICAgICBmYWtlW3BhcmFtZXRlci51cmxdID0gcXVlcnlWYWx1ZXM7XHJcbiAgICAgICAgICAgIHRoaXMuZmlsdGVyRGF0YS5zZXQocGFyYW1ldGVyLl9pZCwgZmFrZSlcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuZmlsdGVyRGF0YS5kZWxldGUocGFyYW1ldGVyLl9pZClcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRVcmxPYmplY3QoKSB7XHJcbiAgICAgICAgbGV0IHZhbHVlcyA9IHRoaXMuZmlsdGVyRGF0YS52YWx1ZXMoKTtcclxuICAgICAgICBsZXQgdmFsdWVzQXJyYXkgPSBBcnJheS5mcm9tKHZhbHVlcyk7XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlc0FycmF5Lmxlbmd0aCA/IE9iamVjdC5hc3NpZ24oe30sIC4uLnZhbHVlc0FycmF5KSA6IHt9O1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyB1cmxUb1BhcmFtZXRlcihwYXJhbWV0ZXI6IFBhcmFtZXRlciwgcXVlcnlQYXJhbXMpIHtcclxuICAgICAgICBzd2l0Y2ggKHBhcmFtZXRlci5iZWhhdmlvcikge1xyXG4gICAgICAgICAgICBjYXNlICdjaGVja2xpc3QnOlxyXG4gICAgICAgICAgICBjYXNlICdyYWRpb2xpc3QnOlxyXG4gICAgICAgICAgICBjYXNlICdvbmVjaGVjayc6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy51cmxUb0ZpbHRlckNoZWNib3hsaXN0KHBhcmFtZXRlciwgcXVlcnlQYXJhbXMpO1xyXG4gICAgICAgICAgICBjYXNlICdpbnB1dCc6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy51cmxUb0ZpbHRlcklucHV0KHBhcmFtZXRlciwgcXVlcnlQYXJhbXMpO1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ9Cd0LXQuNC30LLQtdGB0YLQvdGL0Lkg0YLQuNC/INC/0LDRgNCw0LzQtdGC0YDQsCDRhNC40LvRjNGC0YDQsCcpXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgdXJsVG9GaWx0ZXJDaGVjYm94bGlzdChwYXJhbWV0ZXI6IFBhcmFtZXRlciwgcXVlcnlQYXJhbXM6IGFueSkge1xyXG4gICAgICAgIGZvciAobGV0IHByb3AgaW4gcXVlcnlQYXJhbXMpIHtcclxuICAgICAgICAgICAgaWYgKHBhcmFtZXRlci51cmwgPT0gcHJvcCkge1xyXG5cclxuICAgICAgICAgICAgICAgIHBhcmFtZXRlci52YWx1ZXMuZm9yRWFjaCh2ID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShxdWVyeVBhcmFtc1twcm9wXSkpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHYuc2VsZWN0ZWQgPSBxdWVyeVBhcmFtc1twcm9wXS5pbmNsdWRlcyh2LnVybCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2LnNlbGVjdGVkID0gcXVlcnlQYXJhbXNbcHJvcF0gPT0gdi51cmw7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZmlsdGVyVG9VcmwocGFyYW1ldGVyKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcGFyYW1ldGVyO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgdXJsVG9GaWx0ZXJJbnB1dChwYXJhbWV0ZXI6IFBhcmFtZXRlciwgcXVlcnlQYXJhbXM6IGFueSkge1xyXG4gICAgICAgIGZvciAobGV0IHByb3AgaW4gcXVlcnlQYXJhbXMpIHtcclxuICAgICAgICAgICAgaWYgKHBhcmFtZXRlci51cmwgPT0gcHJvcCkge1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBmcm9tUmVnZXhwID0gbmV3IFJlZ0V4cCgvZnJvbV8oXFxkKykvKSxcclxuICAgICAgICAgICAgICAgICAgICB0b1JlZ2V4cCA9IG5ldyBSZWdFeHAoL3RvXyhcXGQrKS8pLFxyXG4gICAgICAgICAgICAgICAgICAgIGZyb20gPSBmcm9tUmVnZXhwLmV4ZWMocXVlcnlQYXJhbXNbcHJvcF0pLFxyXG4gICAgICAgICAgICAgICAgICAgIHRvID0gdG9SZWdleHAuZXhlYyhxdWVyeVBhcmFtc1twcm9wXSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoZnJvbSlcclxuICAgICAgICAgICAgICAgICAgICBwYXJhbWV0ZXIuZnJvbSA9IGZyb21bMV07XHJcbiAgICAgICAgICAgICAgICBpZiAodG8pXHJcbiAgICAgICAgICAgICAgICAgICAgcGFyYW1ldGVyLnRvID0gdG9bMV07XHJcbiAgICAgICAgICAgICAgICB0aGlzLmZpbHRlclRvVXJsKHBhcmFtZXRlcik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBwYXJhbWV0ZXI7XHJcbiAgICB9XHJcblxyXG5cclxufSJdfQ==