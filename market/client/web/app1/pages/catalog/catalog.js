var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
import { Component, ViewChild } from "@angular/core";
import { ProductProvider } from "providers/product";
import { ParameterProvider } from "providers/parameter";
import { ActivatedRoute, Router } from "@angular/router";
import { ParametersService } from "services/parameters";
import { PagerComponent } from "components/pager/pager";
import { ComponentCatalogFilter } from "./components/filter/filter";
let PageCatalog = class PageCatalog {
    constructor(productProvider, parametersService, parameterProvider, route, router) {
        this.productProvider = productProvider;
        this.parametersService = parametersService;
        this.parameterProvider = parameterProvider;
        this.route = route;
        this.router = router;
        this.products = [];
        this.parameters = [];
    }
    changeFilter(parameter) {
        delete this.page;
        let filterData = this.parametersService.filterToUrl(parameter);
        this.navigate(filterData);
        this.getProducts();
    }
    clearFilter() {
        delete this.page;
        let filterData = this.parametersService.clearFilterData();
        this.navigate(filterData);
        this.selectParameters();
        this.getProducts();
    }
    applyFilter() {
        let filterData = this.parametersService.getFilterData();
        this.navigate(filterData);
        this.getProducts();
    }
    changeSort(sorting) {
        console.log(sorting);
    }
    changePage(page) {
        this.page = page;
        let filterData = this.parametersService.getFilterData();
        this.navigate(filterData);
        this.getProducts();
    }
    ngOnInit() {
        this.categoryName = this.route.snapshot.paramMap.params.categoryName;
        this.page = this.route.snapshot.queryParamMap.params.page;
        this.sort = this.route.snapshot.queryParamMap.params.sort;
        this.params = this.excludeParams(this.route.snapshot.queryParamMap.params);
        this.parameterProvider.getList(this.categoryName).subscribe(response => {
            console.log('получены параметры');
            this.categoryId = response.catid;
            this.parameters = response.parameters;
            this.selectParameters();
            this.getProducts();
            this.getActive();
        });
    }
    excludeParams(params) {
        let p = Object.assign({}, params);
        delete p.page;
        delete p.sort;
        delete p.categoryName;
        return p;
    }
    selectParameters() {
        this.parameters.map(parameter => this.parametersService.urlToParameter(parameter, this.params));
    }
    setActiveParameters(activeParameters) {
        this.parameters.forEach(parameter => {
            parameter.values.forEach(v => {
                v.active = activeParameters.includes(v._id);
            });
        });
    }
    getSelectedParameters() {
        let params = this.parameters.map(x => Object.assign({}, x)).filter((p) => {
            let selected = p.values.find(v => v.selected);
            return p.to || p.from || !!selected;
        });
        params.forEach((p, i, array) => {
            if (p.values)
                p.values = p.values.filter(v => v.selected && v.nomatter != true);
            if (p.behavior != 'input' && p.values.length == 0)
                array.splice(i, 1);
        });
        return params;
    }
    getActive() {
        let query = {
            parameters: this.getSelectedParameters(),
            categoryId: this.categoryId
        };
        this.parameterProvider.getActive(query).subscribe(resp => {
            this.setActiveParameters(resp);
        });
    }
    getProducts() {
        let query = {
            parameters: this.getSelectedParameters(),
            sort: this.sort,
            categoryId: this.categoryId,
            page: this.page
        };
        this.productProvider.list(query).subscribe(resp => {
            console.log('получены продукты');
            this.products = resp.products;
            this.pagerComponent.setup(resp.count, this.page);
        });
    }
    navigate(filterData) {
        let queryParams = Object.assign({}, { page: this.page, sort: this.sort }, filterData);
        this.router.navigate([this.categoryName], { queryParams });
    }
};
__decorate([
    ViewChild(PagerComponent),
    __metadata("design:type", Object)
], PageCatalog.prototype, "pagerComponent", void 0);
__decorate([
    ViewChild(ComponentCatalogFilter),
    __metadata("design:type", Object)
], PageCatalog.prototype, "catalogFilter", void 0);
PageCatalog = __decorate([
    Component({
        templateUrl: 'catalog.html'
    }),
    __metadata("design:paramtypes", [ProductProvider,
        ParametersService,
        ParameterProvider,
        ActivatedRoute,
        Router])
], PageCatalog);
export { PageCatalog };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2F0YWxvZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNhdGFsb2cudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsT0FBTyxFQUFDLFNBQVMsRUFBRSxTQUFTLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFFbkQsT0FBTyxFQUFDLGVBQWUsRUFBQyxNQUFNLG1CQUFtQixDQUFDO0FBRWxELE9BQU8sRUFBQyxpQkFBaUIsRUFBQyxNQUFNLHFCQUFxQixDQUFDO0FBQ3RELE9BQU8sRUFBQyxjQUFjLEVBQUUsTUFBTSxFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFFdkQsT0FBTyxFQUFDLGlCQUFpQixFQUFDLE1BQU0scUJBQXFCLENBQUM7QUFDdEQsT0FBTyxFQUFDLGNBQWMsRUFBQyxNQUFNLHdCQUF3QixDQUFDO0FBQ3RELE9BQU8sRUFBQyxzQkFBc0IsRUFBQyxNQUFNLDRCQUE0QixDQUFDO0FBS2xFLElBQWEsV0FBVyxHQUF4QjtJQWFJLFlBQW9CLGVBQWdDLEVBQ2hDLGlCQUFvQyxFQUNwQyxpQkFBb0MsRUFDcEMsS0FBcUIsRUFDckIsTUFBYztRQUpkLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUNoQyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQ3BDLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7UUFDcEMsVUFBSyxHQUFMLEtBQUssQ0FBZ0I7UUFDckIsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQVpsQyxhQUFRLEdBQWMsRUFBRSxDQUFDO1FBQ3pCLGVBQVUsR0FBZ0IsRUFBRSxDQUFDO0lBWTdCLENBQUM7SUFFRCxZQUFZLENBQUMsU0FBUztRQUNsQixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDakIsSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUMvRCxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzFCLElBQUksQ0FB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RSxFQUFDLFdBQVcsRUFBQyxDQUFDLENBQUM7SUFDN0QsQ0FBQztDQUNKLENBQUE7QUFuSThCO0lBQTFCLFNBQVMsQ0FBQyxjQUFjLENBQUM7O21EQUFnQjtBQUNQO0lBQWxDLFNBQVMsQ0FBQyxzQkFBc0IsQ0FBQzs7a0RBQWU7QUFIeEMsV0FBVztJQUh2QixTQUFTLENBQUM7UUFDUCxXQUFXLEVBQUUsY0FBYztLQUM5QixDQUFDO3FDQWN1QyxlQUFlO1FBQ2IsaUJBQWlCO1FBQ2pCLGlCQUFpQjtRQUM3QixjQUFjO1FBQ2IsTUFBTTtHQWpCekIsV0FBVyxDQXFJdkI7U0FySVksV0FBVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q29tcG9uZW50LCBWaWV3Q2hpbGR9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XHJcbmltcG9ydCB7UHJvZHVjdH0gZnJvbSBcImVudGl0aWVzL3Byb2R1Y3RcIjtcclxuaW1wb3J0IHtQcm9kdWN0UHJvdmlkZXJ9IGZyb20gXCJwcm92aWRlcnMvcHJvZHVjdFwiO1xyXG5cclxuaW1wb3J0IHtQYXJhbWV0ZXJQcm92aWRlcn0gZnJvbSBcInByb3ZpZGVycy9wYXJhbWV0ZXJcIjtcclxuaW1wb3J0IHtBY3RpdmF0ZWRSb3V0ZSwgUm91dGVyfSBmcm9tIFwiQGFuZ3VsYXIvcm91dGVyXCI7XHJcbmltcG9ydCB7UGFyYW1ldGVyfSBmcm9tIFwiZW50aXRpZXMvcGFyYW1ldGVyXCI7XHJcbmltcG9ydCB7UGFyYW1ldGVyc1NlcnZpY2V9IGZyb20gXCJzZXJ2aWNlcy9wYXJhbWV0ZXJzXCI7XHJcbmltcG9ydCB7UGFnZXJDb21wb25lbnR9IGZyb20gXCJjb21wb25lbnRzL3BhZ2VyL3BhZ2VyXCI7XHJcbmltcG9ydCB7Q29tcG9uZW50Q2F0YWxvZ0ZpbHRlcn0gZnJvbSBcIi4vY29tcG9uZW50cy9maWx0ZXIvZmlsdGVyXCI7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICAgIHRlbXBsYXRlVXJsOiAnY2F0YWxvZy5odG1sJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgUGFnZUNhdGFsb2cge1xyXG5cclxuICAgIEBWaWV3Q2hpbGQoUGFnZXJDb21wb25lbnQpIHBhZ2VyQ29tcG9uZW50O1xyXG4gICAgQFZpZXdDaGlsZChDb21wb25lbnRDYXRhbG9nRmlsdGVyKSBjYXRhbG9nRmlsdGVyO1xyXG5cclxuICAgIHByb2R1Y3RzOiBQcm9kdWN0W10gPSBbXTtcclxuICAgIHBhcmFtZXRlcnM6IFBhcmFtZXRlcltdID0gW107XHJcbiAgICBjYXRlZ29yeUlkOiBzdHJpbmc7XHJcbiAgICBjYXRlZ29yeU5hbWU6IHN0cmluZztcclxuICAgIHBhcmFtczogYW55O1xyXG4gICAgcGFnZTogbnVtYmVyO1xyXG4gICAgc29ydDogYW55O1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcHJvZHVjdFByb3ZpZGVyOiBQcm9kdWN0UHJvdmlkZXIsXHJcbiAgICAgICAgICAgICAgICBwcml2YXRlIHBhcmFtZXRlcnNTZXJ2aWNlOiBQYXJhbWV0ZXJzU2VydmljZSxcclxuICAgICAgICAgICAgICAgIHByaXZhdGUgcGFyYW1ldGVyUHJvdmlkZXI6IFBhcmFtZXRlclByb3ZpZGVyLFxyXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSByb3V0ZTogQWN0aXZhdGVkUm91dGUsXHJcbiAgICAgICAgICAgICAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyKSB7XHJcbiAgICB9XHJcblxyXG4gICAgY2hhbmdlRmlsdGVyKHBhcmFtZXRlcikge1xyXG4gICAgICAgIGRlbGV0ZSB0aGlzLnBhZ2U7XHJcbiAgICAgICAgbGV0IGZpbHRlckRhdGEgPSB0aGlzLnBhcmFtZXRlcnNTZXJ2aWNlLmZpbHRlclRvVXJsKHBhcmFtZXRlcik7XHJcbiAgICAgICAgdGhpcy5uYXZpZ2F0ZShmaWx0ZXJEYXRhKTtcclxuICAgICAgICB0aGlzLmdldFByb2R1Y3RzKCk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGNsZWFyRmlsdGVyKCkge1xyXG4gICAgICAgIGRlbGV0ZSB0aGlzLnBhZ2U7XHJcbiAgICAgICAgbGV0IGZpbHRlckRhdGEgPSB0aGlzLnBhcmFtZXRlcnNTZXJ2aWNlLmNsZWFyRmlsdGVyRGF0YSgpO1xyXG4gICAgICAgIHRoaXMubmF2aWdhdGUoZmlsdGVyRGF0YSk7XHJcbiAgICAgICAgdGhpcy5zZWxlY3RQYXJhbWV0ZXJzKCk7XHJcbiAgICAgICAgdGhpcy5nZXRQcm9kdWN0cygpO1xyXG4gICAgfVxyXG5cclxuICAgIGFwcGx5RmlsdGVyKCkge1xyXG4gICAgICAgIGxldCBmaWx0ZXJEYXRhID0gdGhpcy5wYXJhbWV0ZXJzU2VydmljZS5nZXRGaWx0ZXJEYXRhKCk7XHJcbiAgICAgICAgdGhpcy5uYXZpZ2F0ZShmaWx0ZXJEYXRhKTtcclxuICAgICAgICB0aGlzLmdldFByb2R1Y3RzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgY2hhbmdlU29ydChzb3J0aW5nKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coc29ydGluZylcclxuICAgIH1cclxuXHJcbiAgICBjaGFuZ2VQYWdlKHBhZ2UpIHtcclxuICAgICAgICB0aGlzLnBhZ2UgPSBwYWdlO1xyXG4gICAgICAgIGxldCBmaWx0ZXJEYXRhID0gdGhpcy5wYXJhbWV0ZXJzU2VydmljZS5nZXRGaWx0ZXJEYXRhKCk7XHJcbiAgICAgICAgdGhpcy5uYXZpZ2F0ZShmaWx0ZXJEYXRhKTtcclxuICAgICAgICB0aGlzLmdldFByb2R1Y3RzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkluaXQoKSB7XHJcbiAgICAgICAgdGhpcy5jYXRlZ29yeU5hbWUgPSB0aGlzLnJvdXRlLnNuYXBzaG90LnBhcmFtTWFwLnBhcmFtcy5jYXRlZ29yeU5hbWU7XHJcbiAgICAgICAgdGhpcy5wYWdlID0gdGhpcy5yb3V0ZS5zbmFwc2hvdC5xdWVyeVBhcmFtTWFwLnBhcmFtcy5wYWdlO1xyXG4gICAgICAgIHRoaXMuc29ydCA9IHRoaXMucm91dGUuc25hcHNob3QucXVlcnlQYXJhbU1hcC5wYXJhbXMuc29ydDtcclxuICAgICAgICB0aGlzLnBhcmFtcyA9IHRoaXMuZXhjbHVkZVBhcmFtcyh0aGlzLnJvdXRlLnNuYXBzaG90LnF1ZXJ5UGFyYW1NYXAucGFyYW1zKTtcclxuXHJcbiAgICAgICAgdGhpcy5wYXJhbWV0ZXJQcm92aWRlci5nZXRMaXN0KHRoaXMuY2F0ZWdvcnlOYW1lKS5zdWJzY3JpYmUocmVzcG9uc2UgPT4ge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygn0L/QvtC70YPRh9C10L3RiyDQv9Cw0YDQsNC80LXRgtGA0YsnKTtcclxuICAgICAgICAgICAgdGhpcy5jYXRlZ29yeUlkID0gcmVzcG9uc2UuY2F0aWQ7XHJcbiAgICAgICAgICAgIHRoaXMucGFyYW1ldGVycyA9IHJlc3BvbnNlLnBhcmFtZXRlcnM7XHJcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0UGFyYW1ldGVycygpO1xyXG4gICAgICAgICAgICB0aGlzLmdldFByb2R1Y3RzKCk7XHJcbiAgICAgICAgICAgIHRoaXMuZ2V0QWN0aXZlKCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG5cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGV4Y2x1ZGVQYXJhbXMocGFyYW1zKSB7XHJcbiAgICAgICAgbGV0IHAgPSBPYmplY3QuYXNzaWduKHt9LCBwYXJhbXMpO1xyXG4gICAgICAgIGRlbGV0ZSBwLnBhZ2U7XHJcbiAgICAgICAgZGVsZXRlIHAuc29ydDtcclxuICAgICAgICBkZWxldGUgcC5jYXRlZ29yeU5hbWU7XHJcbiAgICAgICAgcmV0dXJuIHA7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzZWxlY3RQYXJhbWV0ZXJzKCkge1xyXG4gICAgICAgIHRoaXMucGFyYW1ldGVycy5tYXAocGFyYW1ldGVyID0+IHRoaXMucGFyYW1ldGVyc1NlcnZpY2UudXJsVG9QYXJhbWV0ZXIocGFyYW1ldGVyLCB0aGlzLnBhcmFtcykpO1xyXG4gICAgfVxyXG5wcml2YXRlIHNldEFjdGl2ZVBhcmFtZXRlcnMoYWN0aXZlUGFyYW1ldGVycykge1xyXG4gICAgICAgIHRoaXMucGFyYW1ldGVycy5mb3JFYWNoKHBhcmFtZXRlciA9PiB7XHJcbiAgICAgICAgICAgIHBhcmFtZXRlci52YWx1ZXMuZm9yRWFjaCh2ID0+IHtcclxuICAgICAgICAgICAgICAgIHYuYWN0aXZlID0gYWN0aXZlUGFyYW1ldGVycy5pbmNsdWRlcyh2Ll9pZClcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9KVxyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBnZXRTZWxlY3RlZFBhcmFtZXRlcnMoKSB7XHJcbiAgICAgICAgbGV0IHBhcmFtcyA9IHRoaXMucGFyYW1ldGVycy5tYXAoeCA9PiBPYmplY3QuYXNzaWduKHt9LCB4KSkuZmlsdGVyKChwOiBQYXJhbWV0ZXIpID0+IHtcclxuICAgICAgICAgICAgbGV0IHNlbGVjdGVkID0gcC52YWx1ZXMuZmluZCh2ID0+IHYuc2VsZWN0ZWQpO1xyXG4gICAgICAgICAgICByZXR1cm4gcC50byB8fCBwLmZyb20gfHwgISFzZWxlY3RlZDtcclxuICAgICAgICB9KTtcclxuICAgICAgICBwYXJhbXMuZm9yRWFjaCgocDogUGFyYW1ldGVyLCBpLCBhcnJheSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAocC52YWx1ZXMpXHJcbiAgICAgICAgICAgICAgICBwLnZhbHVlcyA9IHAudmFsdWVzLmZpbHRlcih2ID0+IHYuc2VsZWN0ZWQgJiYgdi5ub21hdHRlciAhPSB0cnVlKTtcclxuICAgICAgICAgICAgaWYgKHAuYmVoYXZpb3IgIT0gJ2lucHV0JyAmJiBwLnZhbHVlcy5sZW5ndGggPT0gMClcclxuICAgICAgICAgICAgICAgIGFycmF5LnNwbGljZShpLCAxKTtcclxuXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIHBhcmFtcztcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldEFjdGl2ZSgpIHtcclxuICAgICAgICBsZXQgcXVlcnkgPSB7XHJcbiAgICAgICAgICAgIHBhcmFtZXRlcnM6IHRoaXMuZ2V0U2VsZWN0ZWRQYXJhbWV0ZXJzKCksXHJcbiAgICAgICAgICAgIGNhdGVnb3J5SWQ6IHRoaXMuY2F0ZWdvcnlJZFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5wYXJhbWV0ZXJQcm92aWRlci5nZXRBY3RpdmUocXVlcnkpLnN1YnNjcmliZShyZXNwID0+IHtcclxuICAgICAgICAgdGhpcy5zZXRBY3RpdmVQYXJhbWV0ZXJzKHJlc3ApO1xyXG5cclxuICAgICAgICB9KVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0UHJvZHVjdHMoKSB7XHJcbiAgICAgICAgbGV0IHF1ZXJ5ID0ge1xyXG4gICAgICAgICAgICBwYXJhbWV0ZXJzOiB0aGlzLmdldFNlbGVjdGVkUGFyYW1ldGVycygpLFxyXG4gICAgICAgICAgICBzb3J0OiB0aGlzLnNvcnQsXHJcbiAgICAgICAgICAgIGNhdGVnb3J5SWQ6IHRoaXMuY2F0ZWdvcnlJZCxcclxuICAgICAgICAgICAgcGFnZTogdGhpcy5wYWdlXHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLnByb2R1Y3RQcm92aWRlci5saXN0KHF1ZXJ5KS5zdWJzY3JpYmUocmVzcCA9PiB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCfQv9C+0LvRg9GH0LXQvdGLINC/0YDQvtC00YPQutGC0YsnKTtcclxuICAgICAgICAgICAgdGhpcy5wcm9kdWN0cyA9IHJlc3AucHJvZHVjdHM7XHJcbiAgICAgICAgICAgIHRoaXMucGFnZXJDb21wb25lbnQuc2V0dXAocmVzcC5jb3VudCwgdGhpcy5wYWdlKTtcclxuICAgICAgICB9KVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgbmF2aWdhdGUoZmlsdGVyRGF0YSkge1xyXG4gICAgICAgIGxldCBxdWVyeVBhcmFtcyA9IE9iamVjdC5hc3NpZ24oe30sIHtwYWdlOiB0aGlzLnBhZ2UsIHNvcnQ6IHRoaXMuc29ydH0sIGZpbHRlckRhdGEpO1xyXG4gICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFt0aGlzLmNhdGVnb3J5TmFtZV0sIHtxdWVyeVBhcmFtc30pO1xyXG4gICAgfVxyXG59XHJcblxyXG5cclxuIl19