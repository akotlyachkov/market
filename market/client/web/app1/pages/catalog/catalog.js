var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
import { Component, ViewChild } from "@angular/core";
import { ContractProvider, ParameterProvider, ProductProvider } from "providers";
import { ActivatedRoute, Router } from "@angular/router";
import { NavbarService, ParametersService, SortingService } from "services";
import { PagerControl } from "controls/pager/pager";
import { ComponentCatalogFilter } from "./components/filter/filter";
let CatalogPage = class CatalogPage {
    constructor(productProvider, parametersService, parameterProvider, contractProvider, sortingService, navbarService, route, router) {
        this.productProvider = productProvider;
        this.parametersService = parametersService;
        this.parameterProvider = parameterProvider;
        this.contractProvider = contractProvider;
        this.sortingService = sortingService;
        this.navbarService = navbarService;
        this.route = route;
        this.router = router;
        this.products = [];
        this.parameters = [];
        this.xs = false;
    }
    xsChange() {
        this.xs = !this.xs;
    }
    changeFilter(parameter) {
        delete this.page;
        this.navigate();
        this.fetchProducts();
    }
    clearFilter() {
        delete this.page;
        this.parametersService.clearFilterData();
        this.navigate();
        this.fetchParameters();
    }
    applyFilter() {
        this.xs = false;
        this.navigate();
        this.fetchProducts();
    }
    changeSort() {
        this.navigate();
        this.fetchProducts();
    }
    changePage(page) {
        this.page = page;
        this.navigate();
        this.fetchProducts();
    }
    ngOnInit() {
        let pm = this.route.snapshot.paramMap;
        let qpm = this.route.snapshot.queryParamMap;
        this.categoryName = pm.params.categoryName;
        this.page = qpm.params.page;
        this.activeSort = qpm.sort;
        this.params = this.excludeParams(qpm.params);
        this.fetchParameters();
    }
    postPosition(product) {
        let position = {
            product: product._id,
            count: 1,
            price: product.price,
            sum: product.price,
        };
        this.contractProvider.postPosition(position).subscribe(response => {
            console.log(response);
            this.navbarService.updateCartData(response);
        });
    }
    excludeParams(params) {
        let p = Object.assign({}, params);
        delete p.page;
        delete p.sort;
        delete p.categoryName;
        return p;
    }
    selectParameters() {
        this.parameters.map(parameter => this.parametersService.urlToParameter(parameter, this.params));
    }
    setActiveParameters(activeParameters) {
        this.parameters.forEach(parameter => {
            parameter.values.forEach(v => {
                v.active = activeParameters.includes(v._id);
            });
        });
    }
    getSelectedParameters() {
        let params = this.parameters.map(x => Object.assign({}, x)).filter((p) => {
            let selected = p.values.find(v => v.selected);
            return p.to || p.from || !!selected;
        });
        params.forEach((p, i, array) => {
            if (p.values)
                p.values = p.values.filter(v => v.selected && v.nomatter != true);
            if (p.behavior != 'input' && p.values.length == 0)
                array.splice(i, 1);
        });
        return params;
    }
    fetchActive() {
        let query = {
            parameters: this.getSelectedParameters(),
            categoryId: this.categoryId
        };
        this.parameterProvider.getActive(query).subscribe(resp => {
            console.log('получены активные параметры');
            this.setActiveParameters(resp);
        });
    }
    fetchParameters() {
        this.parameterProvider.getList(this.categoryName).subscribe(response => {
            console.log('получены параметры');
            this.categoryId = response.catid;
            this.parameters = response.parameters;
            this.selectParameters();
            this.fetchProducts();
            this.fetchActive();
        });
    }
    fetchProducts() {
        let query = {
            parameters: this.getSelectedParameters(),
            sort: this.sortingService.getSearch(),
            categoryId: this.categoryId,
            page: this.page
        };
        this.productProvider.list(query).subscribe(resp => {
            console.log('получены продукты');
            this.products = resp.products;
            this.pagerComponent.setup(resp.count, this.page);
        });
    }
    navigate() {
        let queryParams = Object.assign({}, { page: this.page }, this.sortingService.getUrl(), this.parametersService.getFilterData());
        this.router.navigate([this.categoryName], { queryParams });
    }
};
__decorate([
    ViewChild(PagerControl),
    __metadata("design:type", Object)
], CatalogPage.prototype, "pagerComponent", void 0);
__decorate([
    ViewChild(ComponentCatalogFilter),
    __metadata("design:type", Object)
], CatalogPage.prototype, "catalogFilter", void 0);
CatalogPage = __decorate([
    Component({
        selector: 'catalog',
        host: { 'class': 'container d-block' },
        templateUrl: 'catalog.html'
    }),
    __metadata("design:paramtypes", [ProductProvider,
        ParametersService,
        ParameterProvider,
        ContractProvider,
        SortingService,
        NavbarService,
        ActivatedRoute,
        Router])
], CatalogPage);
export { CatalogPage };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2F0YWxvZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNhdGFsb2cudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsT0FBTyxFQUFDLFNBQVMsRUFBRSxTQUFTLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFFbkQsT0FBTyxFQUFDLGdCQUFnQixFQUFFLGlCQUFpQixFQUFFLGVBQWUsRUFBQyxNQUFNLFdBQVcsQ0FBQztBQUMvRSxPQUFPLEVBQUMsY0FBYyxFQUFFLE1BQU0sRUFBQyxNQUFNLGlCQUFpQixDQUFDO0FBRXZELE9BQU8sRUFBQyxhQUFhLEVBQUUsaUJBQWlCLEVBQUUsY0FBYyxFQUFDLE1BQU0sVUFBVSxDQUFDO0FBQzFFLE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSxzQkFBc0IsQ0FBQztBQUNsRCxPQUFPLEVBQUMsc0JBQXNCLEVBQUMsTUFBTSw0QkFBNEIsQ0FBQztBQU9sRSxJQUFhLFdBQVcsR0FBeEI7SUFlSSxZQUFvQixlQUFnQyxFQUNoQyxpQkFBb0MsRUFDcEMsaUJBQW9DLEVBQ3BDLGdCQUFrQyxFQUNsQyxjQUE4QixFQUM5QixhQUE0QixFQUM1QixLQUFxQixFQUNyQixNQUFjO1FBUGQsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBQ2hDLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7UUFDcEMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtRQUNwQyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUM5QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM1QixVQUFLLEdBQUwsS0FBSyxDQUFnQjtRQUNyQixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBakJsQyxhQUFRLEdBQWMsRUFBRSxDQUFDO1FBQ3pCLGVBQVUsR0FBZ0IsRUFBRSxDQUFDO1FBTzdCLE9BQUUsR0FBWSxLQUFLLENBQUM7SUFVcEIsQ0FBQztJQUVELFFBQVE7UUFDSixJQUFJLENBQUMsRUFB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cm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xyXG5pbXBvcnQge1Byb2R1Y3R9IGZyb20gXCJtb2RlbHMvcHJvZHVjdFwiO1xyXG5pbXBvcnQge0NvbnRyYWN0UHJvdmlkZXIsIFBhcmFtZXRlclByb3ZpZGVyLCBQcm9kdWN0UHJvdmlkZXJ9IGZyb20gXCJwcm92aWRlcnNcIjtcclxuaW1wb3J0IHtBY3RpdmF0ZWRSb3V0ZSwgUm91dGVyfSBmcm9tIFwiQGFuZ3VsYXIvcm91dGVyXCI7XHJcbmltcG9ydCB7UGFyYW1ldGVyLCBQb3NpdGlvbn0gZnJvbSBcIm1vZGVsc1wiO1xyXG5pbXBvcnQge05hdmJhclNlcnZpY2UsIFBhcmFtZXRlcnNTZXJ2aWNlLCBTb3J0aW5nU2VydmljZX0gZnJvbSBcInNlcnZpY2VzXCI7XHJcbmltcG9ydCB7UGFnZXJDb250cm9sfSBmcm9tIFwiY29udHJvbHMvcGFnZXIvcGFnZXJcIjtcclxuaW1wb3J0IHtDb21wb25lbnRDYXRhbG9nRmlsdGVyfSBmcm9tIFwiLi9jb21wb25lbnRzL2ZpbHRlci9maWx0ZXJcIjtcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gICAgc2VsZWN0b3I6ICdjYXRhbG9nJyxcclxuICAgIGhvc3Q6IHsnY2xhc3MnOiAnY29udGFpbmVyIGQtYmxvY2snfSxcclxuICAgIHRlbXBsYXRlVXJsOiAnY2F0YWxvZy5odG1sJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgQ2F0YWxvZ1BhZ2Uge1xyXG5cclxuICAgIEBWaWV3Q2hpbGQoUGFnZXJDb250cm9sKSBwYWdlckNvbXBvbmVudDtcclxuICAgIEBWaWV3Q2hpbGQoQ29tcG9uZW50Q2F0YWxvZ0ZpbHRlcikgY2F0YWxvZ0ZpbHRlcjtcclxuXHJcbiAgICBwcm9kdWN0czogUHJvZHVjdFtdID0gW107XHJcbiAgICBwYXJhbWV0ZXJzOiBQYXJhbWV0ZXJbXSA9IFtdO1xyXG4gICAgY2F0ZWdvcnlJZDogc3RyaW5nO1xyXG4gICAgY2F0ZWdvcnlOYW1lOiBzdHJpbmc7XHJcbiAgICBwYXJhbXM6IGFueTtcclxuICAgIHBhZ2U6IG51bWJlcjtcclxuICAgIHNvcnQ6IGFueTtcclxuICAgIGFjdGl2ZVNvcnQ6IHN0cmluZztcclxuICAgIHhzOiBib29sZWFuID0gZmFsc2U7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBwcm9kdWN0UHJvdmlkZXI6IFByb2R1Y3RQcm92aWRlcixcclxuICAgICAgICAgICAgICAgIHByaXZhdGUgcGFyYW1ldGVyc1NlcnZpY2U6IFBhcmFtZXRlcnNTZXJ2aWNlLFxyXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBwYXJhbWV0ZXJQcm92aWRlcjogUGFyYW1ldGVyUHJvdmlkZXIsXHJcbiAgICAgICAgICAgICAgICBwcml2YXRlIGNvbnRyYWN0UHJvdmlkZXI6IENvbnRyYWN0UHJvdmlkZXIsXHJcbiAgICAgICAgICAgICAgICBwcml2YXRlIHNvcnRpbmdTZXJ2aWNlOiBTb3J0aW5nU2VydmljZSxcclxuICAgICAgICAgICAgICAgIHByaXZhdGUgbmF2YmFyU2VydmljZTogTmF2YmFyU2VydmljZSxcclxuICAgICAgICAgICAgICAgIHByaXZhdGUgcm91dGU6IEFjdGl2YXRlZFJvdXRlLFxyXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSByb3V0ZXI6IFJvdXRlcikge1xyXG4gICAgfVxyXG5cclxuICAgIHhzQ2hhbmdlKCkge1xyXG4gICAgICAgIHRoaXMueHMgPSAhdGhpcy54cztcclxuICAgIH1cclxuXHJcbiAgICBjaGFuZ2VGaWx0ZXIocGFyYW1ldGVyKSB7XHJcbiAgICAgICAgZGVsZXRlIHRoaXMucGFnZTtcclxuXHJcbiAgICAgICAgdGhpcy5uYXZpZ2F0ZSgpO1xyXG4gICAgICAgIHRoaXMuZmV0Y2hQcm9kdWN0cygpO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBjbGVhckZpbHRlcigpIHtcclxuICAgICAgICBkZWxldGUgdGhpcy5wYWdlO1xyXG4gICAgICAgIHRoaXMucGFyYW1ldGVyc1NlcnZpY2UuY2xlYXJGaWx0ZXJEYXRhKCk7XHJcblxyXG4gICAgICAgIHRoaXMubmF2aWdhdGUoKTtcclxuICAgICAgICB0aGlzLmZldGNoUGFyYW1ldGVycygpO1xyXG4gICAgfVxyXG5cclxuICAgIGFwcGx5RmlsdGVyKCkge1xyXG4gICAgICAgIHRoaXMueHMgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLm5hdmlnYXRlKCk7XHJcbiAgICAgICAgdGhpcy5mZXRjaFByb2R1Y3RzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgY2hhbmdlU29ydCgpIHtcclxuICAgICAgICB0aGlzLm5hdmlnYXRlKCk7XHJcbiAgICAgICAgdGhpcy5mZXRjaFByb2R1Y3RzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgY2hhbmdlUGFnZShwYWdlKSB7XHJcbiAgICAgICAgdGhpcy5wYWdlID0gcGFnZTtcclxuXHJcbiAgICAgICAgdGhpcy5uYXZpZ2F0ZSgpO1xyXG4gICAgICAgIHRoaXMuZmV0Y2hQcm9kdWN0cygpO1xyXG4gICAgfVxyXG5cclxuICAgIG5nT25Jbml0KCkge1xyXG4gICAgICAgIGxldCBwbSA9IHRoaXMucm91dGUuc25hcHNob3QucGFyYW1NYXAgYXMgYW55O1xyXG4gICAgICAgIGxldCBxcG0gPSB0aGlzLnJvdXRlLnNuYXBzaG90LnF1ZXJ5UGFyYW1NYXAgYXMgYW55O1xyXG4gICAgICAgIHRoaXMuY2F0ZWdvcnlOYW1lID0gcG0ucGFyYW1zLmNhdGVnb3J5TmFtZTtcclxuICAgICAgICB0aGlzLnBhZ2UgPSBxcG0ucGFyYW1zLnBhZ2U7XHJcbiAgICAgICAgdGhpcy5hY3RpdmVTb3J0ID0gcXBtLnNvcnQ7XHJcbiAgICAgICAgdGhpcy5wYXJhbXMgPSB0aGlzLmV4Y2x1ZGVQYXJhbXMocXBtLnBhcmFtcyk7XHJcbiAgICAgICAgdGhpcy5mZXRjaFBhcmFtZXRlcnMoKTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgcG9zdFBvc2l0aW9uKHByb2R1Y3Q6IFByb2R1Y3QpIHtcclxuICAgICAgICBsZXQgcG9zaXRpb246IFBvc2l0aW9uID0gPFBvc2l0aW9uPntcclxuICAgICAgICAgICAgcHJvZHVjdDogcHJvZHVjdC5faWQsXHJcbiAgICAgICAgICAgIGNvdW50OiAxLFxyXG4gICAgICAgICAgICBwcmljZTogcHJvZHVjdC5wcmljZSxcclxuICAgICAgICAgICAgc3VtOiBwcm9kdWN0LnByaWNlLFxyXG4gICAgICAgICAgICAvL2NvbG9yOiBuZXcgQ29sb3IoKSAvL9C/0L7QutCwINC30LDRgtGL0YfQutCwXHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLmNvbnRyYWN0UHJvdmlkZXIucG9zdFBvc2l0aW9uKHBvc2l0aW9uKS5zdWJzY3JpYmUoXHJcbiAgICAgICAgICAgIHJlc3BvbnNlID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlc3BvbnNlKTtcclxuICAgICAgICAgICAgICAgIHRoaXMubmF2YmFyU2VydmljZS51cGRhdGVDYXJ0RGF0YShyZXNwb25zZSlcclxuICAgICAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBleGNsdWRlUGFyYW1zKHBhcmFtcykge1xyXG4gICAgICAgIGxldCBwID0gT2JqZWN0LmFzc2lnbih7fSwgcGFyYW1zKTtcclxuICAgICAgICBkZWxldGUgcC5wYWdlO1xyXG4gICAgICAgIGRlbGV0ZSBwLnNvcnQ7XHJcbiAgICAgICAgZGVsZXRlIHAuY2F0ZWdvcnlOYW1lO1xyXG4gICAgICAgIHJldHVybiBwO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2VsZWN0UGFyYW1ldGVycygpIHtcclxuICAgICAgICB0aGlzLnBhcmFtZXRlcnMubWFwKHBhcmFtZXRlciA9PiB0aGlzLnBhcmFtZXRlcnNTZXJ2aWNlLnVybFRvUGFyYW1ldGVyKHBhcmFtZXRlciwgdGhpcy5wYXJhbXMpKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNldEFjdGl2ZVBhcmFtZXRlcnMoYWN0aXZlUGFyYW1ldGVycykge1xyXG4gICAgICAgIHRoaXMucGFyYW1ldGVycy5mb3JFYWNoKHBhcmFtZXRlciA9PiB7XHJcbiAgICAgICAgICAgIHBhcmFtZXRlci52YWx1ZXMuZm9yRWFjaCh2ID0+IHtcclxuICAgICAgICAgICAgICAgIHYuYWN0aXZlID0gYWN0aXZlUGFyYW1ldGVycy5pbmNsdWRlcyh2Ll9pZClcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9KVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0U2VsZWN0ZWRQYXJhbWV0ZXJzKCkge1xyXG4gICAgICAgIGxldCBwYXJhbXMgPSB0aGlzLnBhcmFtZXRlcnMubWFwKHggPT4gT2JqZWN0LmFzc2lnbih7fSwgeCkpLmZpbHRlcigocDogUGFyYW1ldGVyKSA9PiB7XHJcbiAgICAgICAgICAgIGxldCBzZWxlY3RlZCA9IHAudmFsdWVzLmZpbmQodiA9PiB2LnNlbGVjdGVkKTtcclxuICAgICAgICAgICAgcmV0dXJuIHAudG8gfHwgcC5mcm9tIHx8ICEhc2VsZWN0ZWQ7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcGFyYW1zLmZvckVhY2goKHA6IFBhcmFtZXRlciwgaSwgYXJyYXkpID0+IHtcclxuICAgICAgICAgICAgaWYgKHAudmFsdWVzKVxyXG4gICAgICAgICAgICAgICAgcC52YWx1ZXMgPSBwLnZhbHVlcy5maWx0ZXIodiA9PiB2LnNlbGVjdGVkICYmIHYubm9tYXR0ZXIgIT0gdHJ1ZSk7XHJcbiAgICAgICAgICAgIGlmIChwLmJlaGF2aW9yICE9ICdpbnB1dCcgJiYgcC52YWx1ZXMubGVuZ3RoID09IDApXHJcbiAgICAgICAgICAgICAgICBhcnJheS5zcGxpY2UoaSwgMSk7XHJcblxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBwYXJhbXM7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBmZXRjaEFjdGl2ZSgpIHtcclxuICAgICAgICBsZXQgcXVlcnkgPSB7XHJcbiAgICAgICAgICAgIHBhcmFtZXRlcnM6IHRoaXMuZ2V0U2VsZWN0ZWRQYXJhbWV0ZXJzKCksXHJcbiAgICAgICAgICAgIGNhdGVnb3J5SWQ6IHRoaXMuY2F0ZWdvcnlJZFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5wYXJhbWV0ZXJQcm92aWRlci5nZXRBY3RpdmUocXVlcnkpLnN1YnNjcmliZShyZXNwID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coJ9C/0L7Qu9GD0YfQtdC90Ysg0LDQutGC0LjQstC90YvQtSDQv9Cw0YDQsNC80LXRgtGA0YsnKTtcclxuICAgICAgICAgICAgdGhpcy5zZXRBY3RpdmVQYXJhbWV0ZXJzKHJlc3ApO1xyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBmZXRjaFBhcmFtZXRlcnMoKSB7XHJcbiAgICAgICAgdGhpcy5wYXJhbWV0ZXJQcm92aWRlci5nZXRMaXN0KHRoaXMuY2F0ZWdvcnlOYW1lKS5zdWJzY3JpYmUocmVzcG9uc2UgPT4ge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygn0L/QvtC70YPRh9C10L3RiyDQv9Cw0YDQsNC80LXRgtGA0YsnKTtcclxuICAgICAgICAgICAgdGhpcy5jYXRlZ29yeUlkID0gcmVzcG9uc2UuY2F0aWQ7XHJcbiAgICAgICAgICAgIHRoaXMucGFyYW1ldGVycyA9IHJlc3BvbnNlLnBhcmFtZXRlcnM7XHJcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0UGFyYW1ldGVycygpO1xyXG4gICAgICAgICAgICB0aGlzLmZldGNoUHJvZHVjdHMoKTtcclxuICAgICAgICAgICAgdGhpcy5mZXRjaEFjdGl2ZSgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZmV0Y2hQcm9kdWN0cygpIHtcclxuICAgICAgICBsZXQgcXVlcnkgPSB7XHJcbiAgICAgICAgICAgIHBhcmFtZXRlcnM6IHRoaXMuZ2V0U2VsZWN0ZWRQYXJhbWV0ZXJzKCksXHJcbiAgICAgICAgICAgIHNvcnQ6IHRoaXMuc29ydGluZ1NlcnZpY2UuZ2V0U2VhcmNoKCksXHJcbiAgICAgICAgICAgIGNhdGVnb3J5SWQ6IHRoaXMuY2F0ZWdvcnlJZCxcclxuICAgICAgICAgICAgcGFnZTogdGhpcy5wYWdlXHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLnByb2R1Y3RQcm92aWRlci5saXN0KHF1ZXJ5KS5zdWJzY3JpYmUocmVzcCA9PiB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCfQv9C+0LvRg9GH0LXQvdGLINC/0YDQvtC00YPQutGC0YsnKTtcclxuICAgICAgICAgICAgdGhpcy5wcm9kdWN0cyA9IHJlc3AucHJvZHVjdHM7XHJcbiAgICAgICAgICAgIHRoaXMucGFnZXJDb21wb25lbnQuc2V0dXAocmVzcC5jb3VudCwgdGhpcy5wYWdlKTtcclxuICAgICAgICB9KVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgbmF2aWdhdGUoKSB7XHJcbiAgICAgICAgbGV0IHF1ZXJ5UGFyYW1zID0gT2JqZWN0LmFzc2lnbih7fSwge3BhZ2U6IHRoaXMucGFnZX0sIHRoaXMuc29ydGluZ1NlcnZpY2UuZ2V0VXJsKCksIHRoaXMucGFyYW1ldGVyc1NlcnZpY2UuZ2V0RmlsdGVyRGF0YSgpKTtcclxuICAgICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZShbdGhpcy5jYXRlZ29yeU5hbWVdLCB7cXVlcnlQYXJhbXN9KTtcclxuICAgIH1cclxufVxyXG5cclxuXHJcbiJdfQ==